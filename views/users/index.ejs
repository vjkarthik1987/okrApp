<% layout('layouts/dashboard') %>
<% title = 'Users' %>

<style>
  /* Highlight active pagination button */
  .pagination .page-item.active .page-link {
    background-color: #0d6efd; /* Bootstrap primary blue */
    border-color: #0d6efd;
    color: white;
  }

  /* Optional: Slight hover effect on normal buttons */
  .pagination .page-link:hover {
    background-color: #e9ecef;
  }
</style>


<div class="container-fluid">
  
  <h2 class="mb-4">üë• Users</h2>

  <!-- ‚ûï Add New User and Download CSV Buttons -->
  <div class="mb-3 d-flex justify-content-between align-items-center">
    <a href="/<%= orgName %>/users/new" class="btn btn-primary">‚ûï Add New Users</a>
    <button id="downloadCsv" class="btn btn-success">‚¨áÔ∏è Download Users CSV</button>
  </div>

  <!-- üî¢ Active and Inactive Counts -->
  <div class="mb-3">
    <strong>Total Active Users:</strong> <%= users.length %> |
    <strong>Total Deactivated Users:</strong> <%= inactiveUsers.length %>
  </div>

  <!-- üîç Search Box -->
  <div class="mb-3" style="max-width: 400px;">
    <input type="text" id="searchInput" class="form-control" placeholder="Search users by name...">
  </div>

  <% if (users.length === 0) { %>
    <div class="alert alert-warning">No active users found.</div>
  <% } else { %>

    <!-- üßπ Active Users Table inside Responsive -->
    <div class="table-responsive">
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Band</th>
            <th>Location</th>
            <th>Gender</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          <% users.forEach(u => { %>
            <tr>
              <td><%= u.name %></td>
              <td><%= u.email %></td>
              <td><%= u.role %></td>
              <td><%= u.band || '‚Äî' %></td>
              <td><%= u.location || '‚Äî' %></td>
              <td><%= u.gender || '‚Äî' %></td>
              <td>
                <a href="/<%= orgName %>/users/<%= u._id %>/edit" class="btn btn-sm btn-outline-secondary">‚úèÔ∏è Edit</a>
                <% if (!(u.role === 'super_admin' && user.role !== 'super_admin')) { %>
                  <form method="POST" action="/<%= orgName %>/users/<%= u._id %>?_method=DELETE" style="display:inline;">
                    <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?')">üóë Delete</button>
                  </form>                 
                <% } %>           
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- üìÑ Pagination Controls -->
    <nav class="d-flex justify-content-center mt-3">
      <ul id="pagination" class="pagination flex-wrap justify-content-start"></ul>
    </nav>

  <% } %>

  <!-- üí§ Deactivated Users Section -->
  <h5 class="mt-4">Deactivated Users</h5>
  <% if (inactiveUsers.length === 0) { %>
    <div class="text-muted">No deactivated users</div>
  <% } else { %>
    <div class="table-responsive">
      <table class="table table-sm table-bordered">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Reactivate</th>
          </tr>
        </thead>
        <tbody>
          <% inactiveUsers.forEach(u => { %>
            <tr>
              <td><%= u.name %></td>
              <td><%= u.email %></td>
              <td><%= u.role %></td>
              <td>
                <form method="POST" action="/<%= orgName %>/users/<%= u._id %>/reactivate" style="display:inline;">
                  <button class="btn btn-sm btn-outline-success" onclick="return confirm('Reactivate this user?')">‚ôªÔ∏è Reactivate</button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } %>

  <!-- ‚ö° Skipped Users Modal -->
  <% if (skippedUsers && skippedUsers.length > 0) { %>
    <div class="alert alert-warning mt-4">
      ‚ö° <%= skippedUsers.length %> user(s) were skipped.
      <a href="#" data-bs-toggle="modal" data-bs-target="#skippedUsersModal">View Details</a>
    </div>

    <div class="modal fade" id="skippedUsersModal" tabindex="-1" aria-labelledby="skippedUsersModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="skippedUsersModalLabel">Skipped Users</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Reason</th>
                </tr>
              </thead>
              <tbody>
                <% skippedUsers.forEach(u => { %>
                  <tr>
                    <td><%= u.name %></td>
                    <td><%= u.email %></td>
                    <td><%= u.reason %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  <% } %>

</div> <!-- End container-fluid -->

<!-- ‚ú® Scripts Section -->
<script>
  // üßπ CSV Download
  document.getElementById('downloadCsv').addEventListener('click', function () {
    const rows = [
      ["Name", "Email", "Role", "Band", "Location", "Gender"]
    ];

    <% users.forEach(u => { %>
      rows.push([
        "<%= u.name %>",
        "<%= u.email %>",
        "<%= u.role %>",
        "<%= u.band || '' %>",
        "<%= u.location || '' %>",
        "<%= u.gender || '' %>"
      ]);
    <% }) %>

    let csvContent = "data:text/csv;charset=utf-8,"
      + rows.map(e => e.join(",")).join("\n");

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "users_list.csv");
    document.body.appendChild(link);

    link.click();
    document.body.removeChild(link);
  });

  // üîç Live Search
  const tableRows = document.querySelectorAll("#usersTableBody tr");
  document.getElementById('searchInput').addEventListener('input', function () {
    const query = this.value.toLowerCase();
    tableRows.forEach(row => {
      const nameCell = row.children[0].textContent.toLowerCase();
      row.style.display = nameCell.includes(query) ? '' : 'none';
    });
  });

  // üìÑ Pagination
  const rowsPerPage = 10;
  const pagination = document.getElementById("pagination");

  function showPage(page) {
    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    tableRows.forEach((row, index) => {
      row.style.display = (index >= start && index < end) ? '' : 'none';
    });
  }

  function setupPagination() {
    const pageCount = Math.ceil(tableRows.length / rowsPerPage);

    pagination.innerHTML = '';

    for (let i = 1; i <= pageCount; i++) {
      const li = document.createElement('li');
      li.className = 'page-item';
      const a = document.createElement('a');
      a.className = 'page-link';
      a.href = '#';
      a.innerText = i;
      a.addEventListener('click', () => {
        showPage(i);
      });
      li.appendChild(a);
      pagination.appendChild(li);
    }
  }

  setupPagination();
  showPage(1); // Show first page by default
</script>