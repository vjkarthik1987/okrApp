<% layout('layouts/dashboard') %>
<% title = 'All Action Items' %>

<h2>üìã Action Items</h2>

<a href="/<%= orgName %>/actionItems/new" class="btn btn-primary mb-3">‚ûï New Action Item</a>

<table class="table table-bordered table-hover">
  <thead class="table-light">
    <tr>
      <th>Title</th>
      <th>Assigned To</th>
      <th>Meeting</th>
      <th>Due Date</th>
      <th>Status</th>
      <th>Cycle</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <% function renderItem(item, level = 0) { %>
      <tr>
        <td>
          <div class="d-flex align-items-center">
            <span class="me-2 toggle-updates" data-id="<%= item._id %>" style="cursor: pointer;">‚ñ∂</span>
            <div>
              <div><%= '-'.repeat(level + 1) %> <%= item.title %></div>
              <div id="updates-<%= item._id %>" class="mt-1" style="display: none;">
                <% if (item.updates && item.updates.length > 0) { %>
                  <ul class="list-group small">
                    <% item.updates.slice().reverse().forEach(update => { %>
                      <li class="list-group-item px-2 py-1 d-flex justify-content-between">
                        <span><%= update.updateText %></span>
                        <small class="text-muted"><%= new Date(update.updateDate).toLocaleString() %></small>
                      </li>
                    <% }) %>
                  </ul>
                <% } else { %>
                  <div class="text-muted small">No updates yet.</div>
                <% } %>
              </div>
            </div>
            <a href="/<%= orgName %>/actionItems/<%= item._id %>" class="ms-2" title="View details" style="text-decoration: none;">üîç</a>
          </div>
        </td>        
        <td><%= item.assignedTo?.name || item.assignedTo?.email %></td>
        <td><%= item.meeting || '-' %></td>
        <td><%= item.dueDate ? new Date(item.dueDate).toDateString() : '-' %></td>
        <td><%= item.updates?.length ? '‚è≥ In Progress' : 'üÜï New' %></td>
        <td><%= item.cycle?.label %></td>
        <td>
          <a href="/<%= orgName %>/actionItems/<%= item._id %>/edit" class="btn btn-sm btn-outline-primary">Edit</a>
          <form method="POST" action="/<%= orgName %>/actionItems/<%= item._id %>?_method=DELETE" style="display:inline" onsubmit="return confirmDelete()">
            <button class="btn btn-sm btn-outline-danger">Delete</button>
          </form>
        </td>
      </tr>
  
      <% if (item.children && item.children.length > 0) {
        item.children.forEach(child => renderItem(child, level + 1));
      } %>
    <% } %>
  
    <% actionItems.forEach(item => renderItem(item)) %>
  </tbody>
</table>
<script>
  function confirmDelete() {
    return confirm("Are you sure you want to delete this Action Item?");
  }
  function confirmDelete() {
    return confirm("Are you sure you want to delete this Action Item?");
  }

  document.querySelectorAll('.toggle-updates').forEach(el => {
    el.addEventListener('click', () => {
      const id = el.dataset.id;
      const updatesDiv = document.getElementById(`updates-${id}`);
      const isVisible = updatesDiv.style.display === 'block';
      
      updatesDiv.style.display = isVisible ? 'none' : 'block';
      el.textContent = isVisible ? '‚ñ∂' : '‚ñº';
    });
  });
</script>

