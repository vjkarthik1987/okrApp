<% layout('layouts/dashboard') %>
<% title = 'Key Results for ' + objective.title %>

<h2>Key Results for: <%= objective.title %></h2>

<a href="/<%= orgName %>/objectives/<%= objective._id %>/keyresults/new" class="btn btn-primary mb-3">â• Add Key Result</a>
<a href="/<%= orgName %>/objectives/" class="btn btn-outline-secondary mb-3">â¬…ï¸ Back to Objectives</a>

<% if (keyResults.length === 0) { %>
  <div class="alert alert-warning">No key results yet.</div>
<% } else { %>
  <table class="table">
    <thead>
      <tr>
        <th>Title</th>
        <th>Target</th>
        <th>Progress</th>
        <th>Due Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% keyResults.forEach(kr => { %>
        <tr>
          <td>
            <%= kr.title %>
            <a href="/<%= orgName %>/objectives/<%= objective._id %>/keyresults/<%= kr._id %>" title="View Key Result" style="text-decoration: none;">
              ğŸ‘ï¸
            </a>
            <a href="/<%= orgName %>/objectives/<%= objective._id %>/keyresults/<%= kr._id %>/initiatives" class="btn btn-sm btn-outline-primary">ğŸ“‹ View Initiatives</a>
          </td>
          <td><%= kr.targetValue %></td>
          <td><%= kr.progressValue %>%</td>
          <td><%= kr.dueDate ? kr.dueDate.toDateString() : 'â€”' %></td>
          <td>
            <a href="/<%= orgName %>/objectives/<%= objective._id %>/keyresults/<%= kr._id %>/edit" class="btn btn-sm btn-outline-secondary">âœï¸ Edit</a>
            <form method="POST" action="/<%= orgName %>/objectives/<%= objective._id %>/keyresults/<%= kr._id %>/delete" style="display:inline;">
              <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?')">ğŸ—‘ Delete</button>
            </form>
          </td>
        </tr>

        <tr>
          <td colspan="5">

            <% if (kr.metricType === 'milestone' && kr.milestones.length > 0) { %>
              <div class="row">
                <% kr.milestones.forEach((m, i) => { %>
                  <div class="col-md-6">
                    <form method="POST" action="/<%= orgName %>/objectives/<%= objective._id %>/keyresults/<%= kr._id %>/milestone/<%= i %>/toggle">
                      <label class="form-check-label d-flex align-items-center gap-2">
                        <input type="checkbox" onchange="this.form.submit()" <%= m.completed ? 'checked' : '' %> />
                        <%= m.label %> (<%= m.weight %>%)
                      </label>
                    </form>
                  </div>
                <% }) %>
              </div>
            <% } else { %>
              <form action="/<%= orgName %>/objectives/<%= objective._id %>/keyresults/<%= kr._id %>/update" method="POST" class="d-flex gap-2 align-items-start">
                <input type="number" step="any" name="updateValue" class="form-control form-control-sm" required placeholder="Progress value" />
                <input type="text" name="updateText" class="form-control form-control-sm" placeholder="Update note (optional)" />
                <button type="submit" class="btn btn-sm btn-success">Update</button>
              </form>
            <% } %>

            <% if (kr.updates && kr.updates.length > 0) { %>
              <ul class="small text-muted mt-2 mb-0">
                <% [...kr.updates].reverse().forEach((upd, realIndex) => { %> <!-- Use realIndex here -->
                  <li>
                    <%= upd.updateDate.toDateString() %>: <%= upd.updateValue %> (<%= upd.updateText || 'No note' %>)
                    <form method="POST" action="/<%= orgName %>/objectives/<%= objective._id %>/keyresults/<%= kr._id %>/updates/<%= realIndex %>/delete" style="display:inline">
                      <button type="submit" class="btn btn-sm btn-outline-danger btn-link p-0" onclick="return confirm('Delete this update?')">ğŸ—‘</button>
                    </form>
                  </li>
                <% }) %>
              </ul>
            <% } %>

          </td>
        </tr>

      <% }) %>
    </tbody>
  </table>
<% } %>
